function Player(){var timer;var overtime;var myself=this;myself.button={prev:true,play:true,next:true,volume:true,progressControl:true}
myself.analyser=null;myself.event=function(e){}
myself.energy=function(v){}
this.init=function(object){myself.playList=object.playList||[{title:'播放列表为空',album:'',artist:'',mp3:''}];myself.autoPlay=object.autoPlay||false;myself.event=object.event||myself.event;myself.energy=object.energy||myself.energy;myself.button=object.button||myself.button;myself.color=object.color||null;myself.effect=object.effect||0;myself.handle=0;createParts();}
this.change=function(object){myself.effect=object.effect||0;myself.color=object.color||null;drawSpectrum(myself.analyser);}
function windowAudioContext(){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame;window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame;try{myself.audioContext=new AudioContext();}catch(e){console.log('您的浏览器不支持 AudioContext,信息:'+e);}}
function createParts(){var audio=document.createElement("AUDIO");audio.crossOrigin='anonymous';var player=document.getElementsByTagName("player")[0];player.className='visualizer-player';player.appendChild(audio);myself.audio=audio;var songInfo=document.createElement("div");var control=document.createElement("div");var playerShow=document.createElement("div");var playerTime=document.createElement("div");var progress=document.createElement("div");var playerProgressBar=document.createElement("div");songInfo.className='song-info';control.className='player-control';playerShow.className='player-show';playerTime.className='player-time';progress.className='progress';playerProgressBar.className='player-progress-bar';player.appendChild(songInfo);player.appendChild(control);player.appendChild(playerShow);playerShow.appendChild(playerTime);playerShow.appendChild(progress);progress.appendChild(playerProgressBar);myself.songInfo=songInfo;myself.progress=progress;myself.playerProgressBar=playerProgressBar;var button=myself.button;var canvas=document.createElement("canvas");canvas.height=450;canvas.width=player.clientWidth;canvas.style.bottom=player.clientHeight+'px';player.appendChild(canvas);myself.canvas=canvas;if(button.prev){var prevBtn=document.createElement('i');prevBtn.className="icon-previous";prevBtn.id="playPrev";prevBtn.title="上一首";prevBtn.innerHTML="&#xea23;";control.appendChild(prevBtn);var playPrev=document.getElementById("playPrev");playPrev.onclick=function(){prev();}}
if(button.play){var playBtn=document.createElement('i');playBtn.className="icon-play";playBtn.id="playControl";playBtn.title="播放";playBtn.innerHTML="&#xea1c;";playBtn.setAttribute('data','pause');control.appendChild(playBtn);var playControl=document.getElementById("playControl");playControl.onclick=function(){play();}}
if(button.next){var nextBtn=document.createElement('i');nextBtn.className="icon-next";nextBtn.id="playNext";nextBtn.title="下一首";nextBtn.innerHTML="&#xea24;";control.appendChild(nextBtn);var playNext=document.getElementById("playNext");playNext.onclick=function(){next();}}
if(button.volume){var volumeBox=document.createElement('div');volumeBox.id="volumeBox";control.appendChild(volumeBox);var volumeBtn=document.createElement('i');volumeBtn.className="icon-volume";volumeBtn.id="playVolume";volumeBtn.title="音量";if(playBtn){playBtn.setAttribute('data','normal');}
volumeBtn.innerHTML="&#xea27;";volumeBox.appendChild(volumeBtn);var volumeBar=document.createElement('div');volumeBar.id="volumeBar";volumeBox.appendChild(volumeBar);var volumeSize=document.createElement('div');volumeSize.id="volumeSize";volumeBar.appendChild(volumeSize);volumeBar.onclick=function(event){volumeChange(event,volumeBar,volumeSize);}
var volumeBtn=document.getElementById("playVolume");volumeBtn.onclick=function(){volume();}}
playerTime.innerHTML="-&nbsp;00:00&nbsp;/&nbsp;00:00&nbsp;&nbsp;&nbsp;&nbsp;0%";myself.playerTime=playerTime;if(myself.button.progressControl){var progress=myself.progress;progress.style.cursor="pointer";progress.onclick=function(event){progressControl(event,progress);}}
windowAudioContext();var playList=myself.playList;myself.audio.src=playList[0].mp3;var songTitle=document.createElement('div');songTitle.id="songTitle";songInfo.appendChild(songTitle);var album=document.createElement('div');album.id="album";songInfo.appendChild(album);var span=document.createElement('span');span.innerHTML='-';songInfo.appendChild(span);myself.division=span;var artist=document.createElement('div');artist.id="artist";songInfo.appendChild(artist);myself.nowPlay=0;updates();myself.audio.volume=volumeGetCookie();if(myself.autoPlay){play();}}
function play(autoPlay=false){var playBtn=document.getElementById("playControl");if(myself.audio.paused){myself.audio.play();if(playBtn){playBtn.setAttribute("data","play");playBtn.title="暂停";playBtn.innerHTML="&#xea1d;";}
timer=setInterval(function(){showTime();playerState();},1000);updates();if(myself.handle==0){playHandle();}}else{myself.audio.pause();if(playBtn){playBtn.setAttribute("data","pause");playBtn.title="播放";playBtn.innerHTML="&#xea1c;";}
window.clearInterval(timer);}
myself.event({eventType:"play",describe:"播放/暂停",playing:!myself.audio.paused});}
function updates(){var list=myself.playList;var nowPlay=myself.nowPlay;var songTitle=document.getElementById("songTitle");songTitle.innerHTML=list[nowPlay].title;songTitle.title="歌曲:"+list[nowPlay].title;var songAlbum=document.getElementById("album");var albumTitle=list[nowPlay].album;songAlbum.innerHTML=albumTitle?"("+albumTitle+")":'';songAlbum.title="所属专辑:"+albumTitle;var songArtist=document.getElementById("artist");var artistName=list[nowPlay].artist;myself.division.style.display=artistName?'block':'none';songArtist.innerHTML=artistName;songArtist.title="艺术家:"+artistName;}
function playerState(){var state=myself.audio.readyState;var playerState=document.getElementById("player-state");var songInfo=myself.songInfo;if(state==4){if(playerState!=null){songInfo.removeChild(playerState);window.clearTimeout(overtime);}}else{if(playerState==null){playerState=document.createElement("div");playerState.className="player-state";playerState.id="player-state";playerState.innerHTML="<i class='icon-music'>&#xe911;</i>加载中……";songInfo.appendChild(playerState);overtime=setTimeout(function(){if(myself.audio.readyState==0){playerState.innerHTML="加载失败!"}},120000)}}}
function showTime(){if(myself.audio.readyState==4){var duration=myself.audio.duration;var currentTime=myself.audio.currentTime;var surplusTime=duration-currentTime;var ratio=((currentTime/duration)*100).toFixed(1);ratio=ratio==100.0?100:ratio;function timeFormat(t){return Math.floor(t/60)+":"+(t%60/100).toFixed(2).slice(-2);}
myself.playerTime.innerHTML="-&nbsp;"+timeFormat(surplusTime)+"&nbsp;/&nbsp;"+timeFormat(duration)+"&nbsp;&nbsp;&nbsp;&nbsp;"+ratio+"%";myself.playerProgressBar.style.width=ratio+"%";if(ratio==100){next();}}else{myself.playerTime.innerHTML="-&nbsp;00:00&nbsp;/&nbsp;00:00&nbsp;&nbsp;&nbsp;&nbsp;0%";}}
function prev(){if(myself.nowPlay==0){myself.nowPlay=myself.playList.length;}
myself.nowPlay=myself.nowPlay-1;myself.audio.src=myself.playList[myself.nowPlay].mp3;window.clearInterval(timer);if(myself.analyser!=null){drawSpectrum(myself.analyser);}
myself.event({eventType:"prev",describe:"播放上一首"});play();}
function next(){if(myself.nowPlay==myself.playList.length-1){myself.nowPlay=-1;}
myself.nowPlay=myself.nowPlay+1;myself.audio.src=myself.playList[myself.nowPlay].mp3;window.clearInterval(timer);if(myself.analyser!=null){drawSpectrum(myself.analyser);}
myself.event({eventType:"next",describe:"播放上一首"});play();}
function volume(){if(myself.button.volume){var volumeBtn=document.getElementById("playVolume");var data=volumeBtn.getAttribute("data");if(data=="normal"){volumeBtn.setAttribute("data","mute");volumeBtn.innerHTML="&#xea27;";}else{volumeBtn.setAttribute("data","normal");volumeBtn.innerHTML="&#xea2a;"}}
if(myself.audio.muted){myself.audio.muted=false;}else{myself.audio.muted=true;}}
function volumeChange(e,volumeBar,volumeSize){var offsetX=e.offsetX;var width=volumeBar.offsetWidth;var proportion=offsetX/width;volumeSize.style.width=(proportion*100)+"%";var size=proportion;myself.audio.volume=size;volumeSetCookie(size);}
function volumeSetCookie(size){var d=new Date();d.setHours(d.getHours()+(24*30));document.cookie="playerVolume="+size+";expires="+d.toGMTString();}
function volumeGetCookie(){var volumeSize=document.getElementById("volumeSize");var arr,reg=new RegExp("(^| )playerVolume=([^;]*)(;|$)");var volume=1;if(arr=document.cookie.match(reg)){volume=unescape(arr[2]);}else{volume=0.5;}
volumeSize.style.width=volume*100+"%";return volume;}
function progressControl(e,progress){var offsetX=e.offsetX;var width=progress.offsetWidth;var proportion=offsetX/width;var duration=myself.audio.duration;var playTime=duration*proportion;myself.audio.currentTime=playTime;}
function playHandle(){windowAudioContext();var audioContext=myself.audioContext;var analyser=audioContext.createAnalyser();var playData=audioContext.createMediaElementSource(myself.audio);playData.connect(analyser);analyser.connect(audioContext.destination);drawSpectrum(analyser);myself.analyser=analyser;myself.handle=1;}
function drawSpectrum(analyser){var colorArray=['#f82466','#00FFFF','#AFFF7C','#FFAA6A','#6AD5FF','#D26AFF','#FF6AE6','#FF6AB8','#FF6A6A',"#7091FF"];var colorRandom=Math.floor(Math.random()*colorArray.length);myself.colour=myself.color||colorArray[colorRandom];var effectArray=[1,2,3];var effectRandom=Math.floor(Math.random()*effectArray.length);var effect=myself.effect||effectArray[effectRandom];switch(effect){case 1:bar(analyser);break;case 2:circular(analyser);break;case 3:line(analyser);break;default:bar(analyser);}}
function colorRgb(color,opacity){var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;opacity=opacity<0?0:opacity;opacity=opacity>1?1:opacity;if(color&&reg.test(color)){if(color.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=color.slice(i,i+1).concat(color.slice(i,i+1));}
color=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+color.slice(i,i+2)));}
return "rgba("+sColorChange.join(",")+","+opacity+")";}else{return color;}}
function bar(analyser){var canvas=myself.canvas,cwidth=canvas.width,cheight=canvas.height-2,meterWidth=10,capHeight=2,capStyle='#FFFFFF',meterNum=1000/(10+2),ctx=canvas.getContext('2d'),capYPositionArray=[],gradient=ctx.createLinearGradient(0,0,0,300);gradient.addColorStop(1,myself.colour);var drawMeter=function(){var array=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(array);var step=Math.round(array.length/meterNum);ctx.clearRect(0,0,cwidth,cheight);for(var i=0;i<meterNum;i++){var value=array[i*step];if(capYPositionArray.length<Math.round(meterNum)){capYPositionArray.push(value);};ctx.fillStyle=capStyle;if(value<capYPositionArray[i]){ctx.fillRect(i*12,cheight-(--capYPositionArray[i]),meterWidth,capHeight);}else{ctx.fillRect(i*12,cheight-value,meterWidth,capHeight);capYPositionArray[i]=value;};ctx.fillStyle=gradient;ctx.fillRect(i*12,cheight-value+capHeight,meterWidth,cheight);myself.energy(value);}
requestAnimationFrame(drawMeter);}
requestAnimationFrame(drawMeter);}
function circular(analyser){var canvas=myself.canvas,width=canvas.width,height=canvas.height,ctx=canvas.getContext('2d');var drawCircular=function(){var array=new Uint8Array(128);analyser.getByteFrequencyData(array);ctx.clearRect(0,0,width,height);for(var i=0;i<(array.length);i++){var value=array[i];ctx.beginPath();ctx.arc(width/2,height/2,value*0.8,0,400,false);ctx.lineWidth=2;ctx.strokeStyle=(1,colorRgb(myself.colour,value/1000));ctx.stroke();ctx.closePath();myself.energy(value);}
requestAnimationFrame(drawCircular);};requestAnimationFrame(drawCircular);}
function line(analyser){var canvas=myself.canvas,width=canvas.width,height=canvas.height,ctx=canvas.getContext('2d');var drawLine=function(){var array=new Uint8Array(128);analyser.getByteFrequencyData(array);ctx.clearRect(0,0,width,height);ctx.strokeStyle=myself.colour;ctx.lineWidth=2;ctx.beginPath();for(var i=0;i<(array.length);i++){var value=array[i];ctx.lineTo(i*9,value+150);myself.energy(value);};ctx.stroke();ctx.closePath();requestAnimationFrame(drawLine);};requestAnimationFrame(drawLine);}}